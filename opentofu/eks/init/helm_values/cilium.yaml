# k8sServiceHost/Port: Auto-detected by Cilium in EKS with ENI mode
# Can be set explicitly via helm --set if needed
bandwidthManager:
  enabled: true
bpf:
  preallocateMaps: true
# Explicitly specify devices to prevent Cilium from using tailscale0 MTU
# See: https://tailscale.com/kb/1236/kubernetes-operator#cilium
devices: "eth+ pod-id-link+"
egressMasqueradeInterfaces: eth0
eni:
  enabled: true
  # Use secondary CIDR (100.64.0.0/16) subnets for pod IPs with prefix delegation.
  # This provides higher pod density per node.
  # Requires the cilium-cni-configuration ConfigMap (see cilium-cni-config.tf).
  subnetTagsFilter:
    - "cilium.io/pod-subnet=true"
  # Explicit SG and instance discovery needed because subnetTagsFilter restricts
  # ENI cache to pod subnets (100.64.x.x), hiding primary ENIs (10.0.x.x).
  # Without securityGroupTags, the operator can't determine which SGs to attach.
  # Without instanceTagsFilter, nodes without existing Cilium ENIs are invisible.
  # Tag values are set dynamically via helm set in configure/main.tf.
  securityGroupTags: {}
  instanceTagsFilter: []
  awsEnablePrefixDelegation: true

cni:
  # configMap provides the custom CNI config with ENI settings (first-interface-index,
  # subnet-tags, prefix delegation). Since Cilium v1.14, customConf is NOT needed
  # with configMap â€” the agent reads the ConfigMap, writes it to the host, enables
  # cni-exclusive mode, and processes ENI settings into CiliumNode CRDs.
  # Using customConf: true is legacy and sets custom-cni-conf flag which can prevent
  # the agent from populating FirstInterfaceIndex in CiliumNode (defaulting to eth0).
  configMap: cilium-cni-configuration
installNoConntrackIptablesRules: true
ipam:
  mode: eni
kubeProxyReplacement: true
loadBalancer:
  enabled: true
  mode: hybrid
socketLB:
  enabled: true
  # IMPORTANT: Must be true for Tailscale pods to work properly
  # When false, Cilium's socket LB intercepts DNS in pod namespaces,
  # breaking pods that modify their own networking (like Tailscale)
  # See: https://github.com/tailscale/tailscale/issues/15478
  hostNamespaceOnly: true
operator:
  resources:
    limits:
      cpu: 100m
      memory: 100Mi
  rollOutPods: true # Reload pods when the configmap is updated
  # Automatically restart pods not managed by Cilium (replaces manual restart script)
  # Default podRestartSelector is "k8s-app=kube-dns" which only restarts CoreDNS
  # Setting to empty restarts ALL unmanaged pods (EBS CSI, etc.)
  # See: https://docs.cilium.io/en/stable/cmdref/cilium-operator/
  extraArgs:
    - --pod-restart-selector=
  unmanagedPodWatcher:
    intervalSeconds: 15
    restart: true
# Can't enable servicemonitor as the CRD is not yet installed
prometheus:
  enabled: true
  serviceMonitor:
    enabled: false
resources:
  limits:
    cpu: 300m
    memory: 256Mi
routingMode: native
# Note: tunnelProtocol defaults to vxlan in Helm chart but is ignored in native routing mode.
# ENI mode uses direct routing, no tunnel encapsulation is used regardless of this setting.

# WireGuard encryption fixes cross-node L7 proxy with ENI mode.
# Without this, the BPF ipcache incorrectly sets hastunnel flags for remote
# pods in native routing mode, causing Gateway API envoy to fail on cross-node
# backend connections (cilium/cilium#43493). WireGuard node-to-node tunnels
# bypass the faulty hastunnel routing logic.
encryption:
  enabled: true
  type: wireguard

envoy:
  # Explicitly enable Envoy DaemonSet for Gateway API L7 proxy
  enabled: true
  resources:
    limits:
      memory: 300Mi
    requests:
      cpu: 200m
      memory: 300Mi

hubble:
  metrics:
    enabled:
      - dns:query;ignoreAAAA
      - drop
      - tcp
      - flow
      - icmp
      - http
    enableOpenMetrics: true
  relay:
    enabled: true
  ui:
    enabled: true

gatewayAPI:
  enabled: true
