apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: xsqlinstances.cloud.ogenki.io
spec:
  claimNames:
    kind: SQLInstance
    plural: sqlinstances
  connectionSecretKeys:
    - username
    - password
    - endpoint
    - host
    - port
  group: cloud.ogenki.io
  names:
    kind: XSQLInstance
    plural: xsqlinstances
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                rds:
                  type: object
                  properties:
                    deletionPolicy:
                      description: Delete the external resources when the Claim/XR is deleted. Defaults to Delete
                      enum:
                        - Delete
                        - Orphan
                      type: string
                    providerConfigName:
                      description: Crossplane ProviderConfig to use for provisioning this resource
                      type: string
                      default: default
                    engine:
                      type: string
                      description: This RDS Instance engine, see AWS docs for possible values.
                      enum:
                        - postgres
                        - mariadb
                    size:
                      type: string
                      enum:
                        - small
                        - medium
                        - large
                      description: The machine size for this Database Instance.
                    engineVersion:
                      type: string
                      description: This RDS Instance engine version.
                    storageGB:
                      type: integer
                    passwordSecretRef:
                      type: object
                      description: A reference to the Secret object containing the database password.
                      properties:
                        namespace:
                          type: string
                        name:
                          type: string
                        key:
                          type: string
                      required:
                        - namespace
                        - name
                        - key
                    autoGeneratePassword:
                      type: boolean
                    subnetIds:
                      type: array
                      description: A list of subnet IDs where the database will be provisioned.
                      items:
                        type: string
                    vpcId:
                      type: string
                      description: The VPC ID where the database will be provisioned.
                    databases:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                            description: The name of the database.
                          owner:
                            type: string
                            description: The owner of the database.
                        required:
                          - name
                          - owner
                  required:
                    - engine
                    - engineVersion
                    - size
                    - storageGB
                    - passwordSecretRef

                cnpg:
                  type: object
                  properties:
                    instances:
                      type: integer
                      default: 3
                    primaryUpdateStrategy:
                      type: string
                      default: "unsupervised"
                    backup:
                      type: object
                      properties:
                        schedule:
                          type: string
                          nullable: true
                        bucketName:
                          type: string
                          nullable: true
                    postgresql:
                      type: object
                      properties:
                        parameters:
                          type: object
                          additionalProperties: true
                        pg_hba:
                          type: array
                          items:
                            type: string
                          nullable: true
                    resources:
                      type: object
                      properties:
                        requests:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "200m"
                            memory:
                              type: string
                              default: "500Mi"
                        limits:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "200m"
                            memory:
                              type: string
                              default: "500Mi"
                    storage:
                      type: object
                      properties:
                        size:
                          type: string
                          default: "3Gi"
                        storageClass:
                          type: string
                          default: "gp3"
                  required:
                    - instances
                    - database

              oneOf:
                - required: ["rds"]
                - required: ["cnpg"]

            status:
              type: object
              properties:
                rdsAddress:
                  description: Address of the RDS instance.
                  type: string

          required:
            - spec
