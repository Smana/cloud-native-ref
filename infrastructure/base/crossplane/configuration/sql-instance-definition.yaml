apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: sqlinstances.cloud.ogenki.io
spec:
  group: cloud.ogenki.io
  scope: Namespaced
  names:
    kind: SQLInstance
    plural: sqlinstances
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                managementPolicies:
                  description: The management policy for the Pod Identity.
                  type: array
                  items:
                    type: string
                    enum:
                      - "Delete"
                      - "Create"
                      - "Update"
                      - "LateInitialize"
                      - "Observe"
                databases:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: The name of the database.
                      owner:
                        type: string
                        description: The owner of the database.
                    required:
                      - name
                      - owner
                roles:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: The name of the role.
                      comment:
                        type: string
                        description: The comment for the role.
                      superuser:
                        type: boolean
                        description: Is the role a superuser.
                      inRoles:
                        type: array
                        items:
                          type: string
                        description: The roles this role is a member of.
                    required:
                      - name
                      - superuser

                instances:
                  description: The number of instances to create.
                  type: integer
                  default: 3
                primaryUpdateStrategy:
                  description: The update strategy for the primary instance.
                  type: string
                  default: "unsupervised"
                createSuperuser:
                  description: Create a superuser for the Postgres cluster.
                  type: boolean
                  default: false
                objectStoreRecovery:
                  type: object
                  properties:
                    bucketName:
                      description: The name of the S3 bucket to store backups.
                      type: string
                      nullable: true
                    path:
                      description: The path to the backup in the S3 bucket (Usualy a cluster name).
                      type: string
                      nullable: true
                backup:
                  type: object
                  properties:
                    schedule:
                      description: The schedule for backups in cron format.
                      type: string
                      nullable: true
                    bucketName:
                      description: The name of the S3 bucket to store backups.
                      type: string
                      nullable: true
                    retentionPolicy:
                      description: The retention policy for backups.
                      type: string
                      default: "15d"
                initSQL:
                  description: SQL to run on the primary instance after creation.
                  type: string
                  nullable: true
                atlasSchema:
                  description: Configuration for Atlas schema migrations from Git repository.
                  type: object
                  properties:
                    url:
                      description: Git repository URL containing migration files.
                      type: string
                    ref:
                      description: Git reference (tag or branch). Tags starting with 'v' are treated as tags, others as branches.
                      type: string
                    path:
                      description: Path within the repository to the migrations directory containing kustomization.yaml.
                      type: string
                  required:
                    - url
                    - ref
                    - path
                  nullable: true
                postgresVersion:
                  description: The PostgreSQL major version to use (e.g., "17", "18"). Defaults to "18".
                  type: string
                  default: "18"
                performanceInsights:
                  description: |
                    PostgreSQL performance insights and query plan history configuration.
                    Configures pg_stat_statements, auto_explain, and compute_query_id
                    for comprehensive query performance monitoring with execution plan capture.
                  type: object
                  properties:
                    enabled:
                      description: Enable performance insights monitoring (pg_stat_statements).
                      type: boolean
                      default: false
                    explain:
                      description: |
                        Auto-explain configuration for capturing query execution plans.
                        When enabled, automatically logs execution plans for slow queries.
                      type: object
                      properties:
                        sampleRate:
                          description: |
                            Sample rate for auto_explain query plan capture (0.0 to 1.0).
                            - 0.2 (default): Capture 20% of slow queries (production-safe, balanced visibility)
                            - 1.0: Capture all slow queries for debugging (higher overhead)
                            - 0.1: Capture 10% for high-traffic production (minimal overhead)
                            - 0.0: Disable query plan capture (only collect pg_stat_statements metrics)
                          type: number
                          default: 0.2
                          minimum: 0.0
                          maximum: 1.0
                        minDuration:
                          description: |
                            Minimum query duration (in milliseconds) to trigger auto_explain logging.
                            - 1000 (default): Log queries taking longer than 1 second
                            - 100: More aggressive logging for performance debugging
                            - 0: Log ALL queries (warning: high overhead, use only for debugging)
                            - -1: Disable auto_explain completely (only use pg_stat_statements)
                          type: integer
                          default: 1000
                          minimum: -1
                      nullable: true
                    logStatement:
                      description: |
                        Controls which SQL statements are logged (log_statement parameter).
                        - none (default): No statement logging, rely on auto_explain for slow queries
                        - ddl: Log DDL statements (CREATE, ALTER, DROP) for schema change auditing
                        - mod: Log DDL + data modifications (INSERT, UPDATE, DELETE) for data change auditing
                        - all: Log ALL SQL statements (WARNING: 10-30% overhead, use only for debugging)

                        Note: This is independent of auto_explain. auto_explain captures execution plans for
                        slow queries, while log_statement logs the SQL text of all matching statements.
                      type: string
                      enum:
                        - none
                        - ddl
                        - mod
                        - all
                      default: none
                  nullable: true
                postgresql:
                  type: object
                  properties:
                    parameters:
                      description: Custom Postgres parameters to set.
                      type: object
                      additionalProperties: true
                    pg_hba:
                      description: Custom pg_hba.conf entries.
                      type: array
                      items:
                        type: string
                      nullable: true
                size:
                  description: The machine size for this Database Instance.
                  type: string
                  enum:
                    - small
                    - medium
                    - large
                storageSize:
                  type: string
                storageClass:
                  description: The storage class to use for the Postgres cluster.
                  type: string
                  default: "gp3"
              required:
                - instances
                - size
                - storageSize
            status:
              type: object
              properties:
                instanceAddress:
                  description: Address of the Database instance.
                  type: string
          required:
            - spec
