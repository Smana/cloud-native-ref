# Flux Custom Resources Overview

Flux consists of the following controllers and CRDs:

- Flux Operator
  - **FluxInstance**: Manages Flux controllers installation and configuration
  - **FluxReport**: Reflects state of a Flux installation
  - **ResourceSet**: Manages groups of Kubernetes resources based on input matrices
  - **ResourceSetInputProvider**: Fetches input values from external services (GitHub, GitLab)
- Source Controller
  - **GitRepository**: Git repo containing manifests or Helm charts
  - **OCIRepository**: Container registry containing OCI artifacts
  - **Bucket**: S3-compatible bucket containing manifests
  - **HelmRepository**: Helm chart repository
  - **HelmChart**: References a chart from HelmRepository or GitRepository
- Kustomize Controller
  - **Kustomization**: Builds and applies manifests from sources
- Helm Controller
  - **HelmRelease**: Manages Helm chart releases from sources
- Notification Controller
  - **Provider**: Notification service (Slack, MS Teams, etc.)
  - **Alert**: Configures events to forward to providers
  - **Receiver**: Webhooks for triggering reconciliations
- Image Automation Controllers
  - **ImageRepository**: Scans container registries for new tags
  - **ImagePolicy**: Selects latest image tag based on policy
  - **ImageUpdateAutomation**: Updates Git repository with new image tags

For deep understanding, call `search_flux_docs` for each resource kind.

# Flux GitOps Troubleshooting

## General Kubernetes Rules

- When asked about Kubernetes resources, call the `get_kubernetes_resources` tool.
- Don't assume `apiVersion` - call `get_kubernetes_api_versions` to find the correct one.
- When asked to use a specific cluster, call `get_kubernetes_contexts` then `set_kubernetes_context`.
- When asked to create/update resources, generate YAML and call `apply_kubernetes_resource`.

## Kubernetes Logs Analysis

1. Get the Deployment via `get_kubernetes_resources`
2. Find `matchLabels` and container name from the deployment spec
3. List pods with those labels
4. Get logs via `get_kubernetes_logs` using pod name and container name

## Flux-Specific Rules

- Check Flux installation: call `get_flux_instance`
- After switching context: call `get_flux_instance` for Flux Operator status
- To check if a resource is Flux-managed: look for `fluxcd` labels in metadata
- Avoid modifying Flux-managed resources unless explicitly requested
- For Flux CRD docs: call `search_flux_docs`

## HelmRelease Analysis

1. Check helm-controller status and HelmRelease apiVersion via `get_flux_instance`
2. Get the HelmRelease, analyze spec/status/inventory/events
3. Check managing object (Kustomization or ResourceSet) via annotations
4. If `valuesFrom` present, get referenced ConfigMaps/Secrets
5. Identify source via `chartRef` or `sourceRef`, check source status
6. If failed, check inventory managed resources and their logs
7. Create root cause analysis or status report

## Kustomization Analysis

1. Check kustomize-controller status and Kustomization apiVersion via `get_flux_instance`
2. Get the Kustomization, analyze spec/status/inventory/events
3. Check managing object via annotations
4. If `substituteFrom` present, get referenced ConfigMaps/Secrets
5. Identify source via `sourceRef`, check source status
6. If failed, check inventory managed resources and their logs
7. Create root cause analysis or status report

## Flux Comparison Analysis

1. Get cluster contexts via `get_kubernetes_contexts`
2. Switch context, check `get_flux_instance`, get the resource
3. If `valuesFrom`/`substituteFrom`, get referenced ConfigMaps/Secrets
4. Repeat for each cluster
5. Compare `spec` (desired state), `status`, and `events` including referenced resources

# Crossplane Troubleshooting

## Initial Assessment
- List XRDs and Compositions via `get_kubernetes_resources`
- Get the XR instance, analyze spec/status/conditions/events
- Check readiness: `Ready`, `Synced`, provider-specific conditions
- Use `crossplane beta trace <xr-name>` for resource hierarchy

## Composition Analysis
- Check `compositionRef`/`compositionSelector` on the XR
- Get the Composition, analyze `spec.pipeline`/`spec.resources`/`spec.functions`
- For function pipelines: examine function order, inputs, dependencies

## Managed Resource Investigation
- Extract managed resources from XR `status.resources`
- Check each for status, conditions, events
- Common failures: IAM 403, naming conflicts, provider auth, missing dependencies, validation errors

## Provider and Controller Analysis
- Check Crossplane core controller status in `crossplane-system`
- Check provider controller readiness
- If failing, fetch controller pod logs
- Verify ProviderConfig authentication

## Advanced CLI Diagnostics
- `crossplane beta trace <xr-name> --show-connection-secrets` for dependency graph
- `crossplane beta top -s` for controller resource usage
- `crossplane render <xr> <composition> | crossplane beta validate -` for validation

## Common Issue Resolution
- **IAM**: Check EKS Pod Identity associations and AWS IAM policies
- **Function Pipeline**: Validate ordering, context propagation, gRPC communication
- **Schema Validation**: Check unknown fields, missing params, type mismatches
- **Resource Naming**: Ensure compliance with provider naming conventions

# Platform-Specific Guidelines

## AWS EKS
- For service account permissions: check EKS Pod Identity associations and IAM policies
- Always confirm AWS region and EKS cluster name when switching/referencing clusters

## Cilium (CNI & Network Policies)
- For connectivity issues: check Cilium pod logs and CiliumNetworkPolicy resources
- Use Hubble for network observability:
  ```bash
  CILIUM_POD=$(kubectl get pods -n kube-system -l k8s-app=cilium -o jsonpath='{.items[0].metadata.name}')
  kubectl exec -n kube-system $CILIUM_POD -- hubble observe --verdict DROPPED --from-pod <ns>/<pod> --last 100
  kubectl exec -n kube-system $CILIUM_POD -- hubble observe --from-label app.kubernetes.io/name=<app> --verdict DROPPED --last 100
  ```

## Gateway API
- Prefer Gateway API resources (`Gateway`, `HTTPRoute`, `GatewayClass`) over legacy `Ingress`
- Cilium is configured as the Gateway API implementation
