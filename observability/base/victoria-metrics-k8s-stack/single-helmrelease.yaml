apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics-k8s-stack
spec:
  releaseName: victoria-metrics-k8s-stack
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
        namespace: observability
      version: "0.25.3"
  interval: 4m0s
  timeout: 30m
  install:
    remediation:
      retries: 3
  values:
    tenant: "0"

    ## -- Might be interesting to have a look to the Grafana Operator
    grafanaOperatorDashboardsFormat:
      enabled: false
      instanceSelector:
        matchLabels:
          dashboards: "grafana"
      allowCrossNamespaceImport: false

    vmsingle:
      spec:
        retentionPeriod: "1d" # Minimal retention, for tests only
        replicaCount: 1
        storage:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi

    alertmanager:
      enabled: true

      spec:
        secrets:
          - "victoria-metrics-k8s-stack-alertmanager-slack-app"

      config:
        global:
          slack_api_url: "https://slack.com/api/chat.postMessage"
          http_config:
            authorization:
              credentials_file: /etc/vm/secrets/victoria-metrics-k8s-stack-alertmanager-slack-app/token

        route:
          receiver: "slack-monitoring"

        inhibit_rules:
          - target_matchers:
              - severity=info
            source_matchers:
              - alertname=InfoInhibitor

        receivers:
          - name: "slack-monitoring"
            slack_configs:
              - channel: "#alerts"
                send_resolved: true
                title: '{{ template "slack.monzo.title" . }}'
                icon_emoji: '{{ template "slack.monzo.icon_emoji" . }}'
                color: '{{ template "slack.monzo.color" . }}'
                text: '{{ template "slack.monzo.text" . }}'
                actions:
                  - type: button
                    text: "Runbook :green_book:"
                    url: "{{ (index .Alerts 0).Annotations.runbook_url }}"
                  - type: button
                    text: "Query :mag:"
                    url: "{{ (index .Alerts 0).GeneratorURL }}"
                  - type: button
                    text: "Dashboard :grafana:"
                    url: "{{ (index .Alerts 0).Annotations.dashboard }}"
                  - type: button
                    text: "Silence :no_bell:"
                    url: '{{ template "__alert_silence_link" . }}'
                  - type: button
                    text: '{{ template "slack.monzo.link_button_text" . }}'
                    url: "{{ .CommonAnnotations.link_url }}"

    grafana:
      admin:
        existingSecret: "victoria-metrics-k8s-stack-grafana-admin"
      sidecar:
        datasources:
          enabled: true
          initDatasources: true
        plugins:
          - "https://github.com/VictoriaMetrics/grafana-datasource/releases/download/v0.5.0/victoriametrics-datasource-v0.5.0.zip;victoriametrics-datasource"
        grafana.ini:
          plugins:
            allow_loading_unsigned_plugins: victoriametrics-datasource
        defaultDatasourceType: "victoriametrics-datasource"
        dashboards:
          additionalDashboardLabels: {}
          additionalDashboardAnnotations: {}
          enabled: true
          multicluster: false

      additionalDataSources:
        - name: Loki
          type: loki
          url: http://loki-gateway
          jsonData:
            httpHeaderName1: "X-Scope-OrgID"
          secureJsonData:
            httpHeaderValue1: "1"

      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - name: "default"
              orgId: 1
              folder: ""
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default
            - name: "flux"
              orgId: 1
              folder: "Flux"
              type: file
              disableDeletion: true
              editable: true
              options:
                path: /var/lib/grafana/dashboards/flux
            - name: "karpenter"
              orgId: 1
              folder: "Karpenter"
              type: file
              disableDeletion: true
              editable: true
              options:
                path: /var/lib/grafana/dashboards/karpenter
            - name: "loki"
              orgId: 1
              folder: "Loki"
              type: file
              disableDeletion: true
              editable: true
              options:
                path: /var/lib/grafana/dashboards/loki
            - name: "views"
              orgId: 1
              folder: "Views"
              type: file
              disableDeletion: true
              editable: true
              options:
                path: /var/lib/grafana/dashboards/views

      dashboards:
        default:
          nodeexporter:
            gnetId: 1860
            revision: 22
            datasource: VictoriaMetrics
        flux:
          flux-controlplane:
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/main/monitoring/configs/dashboards/control-plane.json
            datasource: VictoriaMetrics
          flux-cluster:
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/main/monitoring/configs/dashboards/cluster.json
            datasource: VictoriaMetrics
          flux-logs:
            url: https://raw.githubusercontent.com/fluxcd/flux2-monitoring-example/main/monitoring/configs/dashboards/logs.json
            datasource: Loki
        karpenter:
          default:
            gnetId: 18862
            revision: 2
            datasource: VictoriaMetrics
        # Dashboards from https://github.com/dotdc/grafana-dashboards-kubernetes
        views:
          k8s-views-global:
            url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-global.json
            datasource: VictoriaMetrics
          k8s-views-namespaces:
            url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-namespaces.json
            datasource: VictoriaMetrics
          k8s-views-nodes:
            url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-nodes.json
            datasource: VictoriaMetrics
          k8s-views-pods:
            url: https://raw.githubusercontent.com/dotdc/grafana-dashboards-kubernetes/master/dashboards/k8s-views-pods.json
            datasource: VictoriaMetrics

    # Do not scrape controlplane components as it is a managed service on EKS
    kubeApiServer:
      enabled: false
    kubeControllerManager:
      enabled: false
    kubeEtcd:
      enabled: false
    kubeScheduler:
      enabled: false
    kubeProxy:
      enabled: false

    # Deployed with all the other CRDs, flux kustomization
    crds:
      enabled: false
