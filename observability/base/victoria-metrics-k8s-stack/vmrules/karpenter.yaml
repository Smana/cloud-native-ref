apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  labels:
    app: karpenter
  name: karpenter
  namespace: karpenter
spec:
  groups:
    - name: karpenter
      rules:
        - alert: KarpenterCanNotRegisterNewNodes
          expr: sum by (nodepool) (karpenter_nodeclaims_launched) - sum by (nodepool)(karpenter_nodeclaims_registered) != 0
          for: 15m
          labels:
            severity: warning
          annotations:
            description: |
              Karpenter in the nodepool {{ $labels.nodeppol }} launched new nodes, but some of the nodes did not register in the cluster during 15 minutes.
            summary: Problem with registering new nodes in the cluster.
            runbook_url: "https://runbook.url"
            dashboard: "https://dashboard.url"
            link_url: "https://link.url"

        - alert: KarpenterNodepoolAlmostFull
          expr: sum by (nodepool,resource_type) (karpenter_nodepool_usage) / sum by (nodepool,resource_type) (karpenter_nodepool_limit) * 100 > 80
          for: 15m
          labels:
            severity: warning
          annotations:
            description: |
              Nodepool {{ $labels.nodeppol }} has launched {{ $value }}% of {{ $labels.resource_type }} resources of the limit.
            summary: Nodepool almost full, you should increase limits.
            runbook_url: "https://runbook.url"
            dashboard: "https://dashboard.url"
            link_url: "https://link.url"

        - alert: KarpenterCloudproviderErrors
          expr: increase(karpenter_cloudprovider_errors_total[10m]) > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            description: |
              Karpenter received an error during an API call to the cloud provider.
            summary: Cloud provider errors detected by Karpenter.
            runbook_url: "https://runbook.url"
            dashboard: "https://dashboard.url"
            link_url: "https://link.url"
