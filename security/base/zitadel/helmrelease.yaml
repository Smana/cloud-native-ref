apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zitadel
spec:
  interval: 30m
  timeout: 45m
  driftDetection:
    mode: enabled
  chart:
    spec:
      chart: zitadel
      version: "9.16.0"
      sourceRef:
        kind: HelmRepository
        name: zitadel
        namespace: security
      interval: 12h
  values:
    replicaCount: 1
    initJob:
      backoffLimit: 30 # Wait for the CNPG database instance to be ready

    # Fix for missing alpine/k8s:1.34.2 image (chart default doesn't exist)
    setupJob:
      machinekeyWriter:
        image:
          tag: "1.35.0"

    # Login v2 disabled due to Helm chart bug with pod-level TLS
    # Bug: Init container uses HTTPS for internal connections when TLS.Enabled=true
    # Using embedded login UI instead (same features, simpler architecture)
    login:
      enabled: false
    zitadel:
      serverSslCrtSecret: "zitadel-certificate"
      masterkeySecretName: "zitadel-masterkey" # Populated from the zitadel-envvars secret
      configmapConfig:
        Log:
          Formatter:
            Format: json
        ExternalPort: 443
        ExternalSecure: true
        ExternalDomain: "auth.${domain_name}"
        TLS:
          Enabled: true
          KeyPath: /tls/tls.key
          CertPath: /tls/tls.crt
        Database:
          Postgres:
            Host: xplane-zitadel-cnpg-cluster-rw
            Port: 5432
            Database: zitadel
            MaxOpenConns: 20
            MaxIdleConns: 10
            MaxConnLifetime: 30m
            MaxConnIdleTime: 5m

        # FirstInstance configuration for v9 (initializes service accounts)
        FirstInstance:
          Org:
            Machine:
              Machine:
                Username: 'iam-admin'
                Name: 'IAM Admin Service Account'
              MachineKey:
                ExpirationDate: '2029-01-01T00:00:00Z'
                Type: 1
              Pat:
                ExpirationDate: '2029-01-01T00:00:00Z'

    # reference: https://zitadel.com/docs/self-hosting/manage/configure
    # All configuration items are loaded from a secret
    # These are the keys that are expected in the secret
    # ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
    # ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE
    # ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME
    # ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
    # ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE
    # ZITADEL_DATABASE_POSTGRES_USER_USERNAME
    # ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD
    # ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME
    # ZITADEL_MASTERKEY
    envVarsSecret: "zitadel-envvars"

    # Mount certificate generated by cert-manager
    extraVolumes:
      - name: zitadel-certificate
        secret:
          defaultMode: 420
          secretName: zitadel-certificate
    extraVolumeMounts:
      - name: zitadel-certificate
        mountPath: /tls
        readOnly: true
