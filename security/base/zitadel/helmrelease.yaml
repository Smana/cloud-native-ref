apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zitadel
spec:
  interval: 30m
  driftDetection:
    mode: enabled
  chart:
    spec:
      chart: zitadel
      version: "8.5.0"
      sourceRef:
        kind: HelmRepository
        name: zitadel
      interval: 12h
  values:
    initJob:
      backoffLimit: 30 # The database (RDS) takes time to initialize
    zitadel:
      # reference: https://zitadel.com/docs/self-hosting/manage/configure
      masterkey: ApnB2MUlRa63KRIE0iT1WlM4ZNZOvZF6
      configmapConfig:
        Log:
          Formatter:
            Format: json
        ExternalPort: 443
        ExternalSecure: true
        ExternalDomain: "zitadel.priv.${domain_name}"
        TLS:
          Enabled: true
          KeyPath: /tls/tls.key
          CertPath: /tls/tls.crt
        Database:
          Postgres:
            Host: xplane-zitadel-rds-service
            Port: 5432
            Database: zitadel
            MaxOpenConns: 20
            MaxIdleConns: 10
            MaxConnLifetime: 30m
            MaxConnIdleTime: 5m

    envVarsSecret: "zitadel-envvars"

    # Mount certificate generated by cert-manager
    extraVolumes:
      - name: zitadel-certificate
        secret:
          defaultMode: 420
          secretName: zitadel-certificate
    extraVolumeMounts:
      - name: zitadel-certificate
        mountPath: /tls
        readOnly: true
