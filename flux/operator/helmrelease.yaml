apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-operator
  namespace: flux-system
spec:
  interval: 10m
  releaseName: flux-operator
  chartRef:
    kind: OCIRepository
    name: flux-operator
  values:
    logLevel: "info"
    web:
      enabled: true
      # Disable the default NetworkPolicy that blocks Gateway API L7 proxy traffic
      # The allow-egress NetworkPolicy in FluxInstance is already patched to allow ingress
      networkPolicy:
        create: false
      config:
        # Public URL for OAuth2 redirects
        baseURL: "https://flux-ui-${cluster_name}.${domain_name}"
        authentication:
          type: OAuth2
          sessionDuration: 24h
          oauth2:
            provider: OIDC
            issuerURL: "https://auth.cloud.ogenki.io"
            # clientID and clientSecret injected from secret via valuesFrom
            scopes:
              - openid
              - profile
              - email
            # Map Zitadel claims to Kubernetes identity
            # Zitadel Action sets both 'roles' and 'groups' claims
            # Using 'groups' to match Flux Operator's standard expectation
            impersonation:
              # Use email for human-readable usernames in audit logs
              username: "claims.email"
              # Zitadel Action: api.v1.claims.setClaim('groups', grants)
              groups: "claims.groups"
            # Restrict access to @ogenki.io email domain
            # Note: Requires "User Info inside ID Token" enabled in Zitadel
            # validations:
            #   - expression: "claims.email.endsWith('@ogenki.io')"
            #     message: "Access denied: must use @ogenki.io email"
  # Inject OIDC credentials from ExternalSecret
  valuesFrom:
    - kind: Secret
      name: flux-ui-oidc
      valuesKey: clientID
      targetPath: web.config.authentication.oauth2.clientID
    - kind: Secret
      name: flux-ui-oidc
      valuesKey: clientSecret
      targetPath: web.config.authentication.oauth2.clientSecret
